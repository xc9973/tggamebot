# 实现计划: 骰宝游戏

## 概述

本实现计划将骰宝游戏模块分解为增量式的开发任务。每个任务都建立在前一个任务的基础上，确保代码逐步集成。我们将复用现有的 DatabaseManager、UserRepository、AccountManager 等组件，使用 Python 3.10+ 和 Hypothesis 进行属性测试。

## 任务

- [x] 1. 数据模型和枚举定义
  - [x] 1.1 创建骰宝游戏数据模型
    - 在 src/models.py 中添加 GamePhase 枚举（IDLE, BETTING, ROLLING, SETTLING）
    - 添加 BetType 枚举（SINGLE, PAIR, SUM, BIG, SMALL）
    - 添加 SicBoBet 数据类（user_id, bet_type, amount, numbers, created_at）
    - 添加 SicBoGame 数据类（chat_id, phase, bets, dice_results, created_at, betting_end_time）
    - _需求: 1.1, 2.1, 3.1, 4.1, 5.1_

- [x] 2. 赔率计算器实现
  - [x] 2.1 实现 SicBoCalculator 类
    - 创建 src/sicbo_calculator.py 文件
    - 实现 is_triple 方法（判断围骰）
    - 实现 calculate_single_payout 方法（单一数字赔率：0匹配返回0，1匹配返回bet*2，2匹配返回bet*3，3匹配返回bet*4）
    - 实现 calculate_pair_payout 方法（组合赔率：匹配返回bet*6，否则0）
    - 实现 calculate_sum_payout 方法（总和赔率：围骰返回0，否则按赔率表）
    - 实现 calculate_big_small_payout 方法（大小赔率：围骰返回0，否则匹配返回bet*2）
    - 实现 calculate_bet_payout 方法（统一入口）
    - _需求: 2.3, 2.4, 2.5, 2.6, 3.4, 3.5, 4.3, 4.4, 4.5, 5.3, 5.4, 5.5_

  - [x] 2.2 为围骰判定编写属性测试
    - **属性 12: 围骰判定正确性**
    - **验证需求: 4.4, 5.5**

  - [x] 2.3 为单一数字赔率编写属性测试
    - **属性 6: 单一数字赔率正确性**
    - **验证需求: 2.3, 2.4, 2.5, 2.6**

  - [x] 2.4 为组合赔率编写属性测试
    - **属性 7: 两个数字组合赔率正确性**
    - **验证需求: 3.4, 3.5, 3.6**

  - [x] 2.5 为总和赔率编写属性测试
    - **属性 8: 总和赔率正确性**
    - **验证需求: 4.3, 4.4, 4.5**

  - [x] 2.6 为大小赔率编写属性测试
    - **属性 9: 大小赔率正确性**
    - **验证需求: 5.3, 5.4, 5.5**

  - [x] 2.7 为围骰通吃规则编写属性测试
    - **属性 11: 围骰通吃规则**
    - **验证需求: 4.4, 5.5**

- [x] 3. 检查点 - 确保赔率计算测试通过
  - 运行所有赔率计算相关测试
  - 确认所有测试通过，如有问题请询问用户

- [ ] 4. 游戏管理器实现
  - [x] 4.1 实现 SicBoManager 类基础功能
    - 创建 src/sicbo_manager.py 文件
    - 实现 __init__ 方法（初始化 active_games 字典）
    - 实现 start_game 方法（创建游戏会话，检查互斥性）
    - 实现 get_game 方法（获取当前游戏）
    - 实现 get_game_stats 方法（获取游戏统计）
    - _需求: 1.1, 1.2, 1.3, 8.4_

  - [x] 4.2 为游戏会话互斥性编写属性测试
    - **属性 1: 游戏会话互斥性**
    - **验证需求: 1.1, 1.2**

  - [x] 4.3 实现下注功能
    - 实现 place_bet 方法（验证输入、检查余额、扣款、记录押注）
    - 实现 validate_bet_input 方法（验证数字范围、组合有效性）
    - 实现 get_user_bets 方法（获取用户押注）
    - _需求: 2.1, 2.2, 3.1, 3.2, 3.3, 4.1, 4.2, 5.1, 5.2, 7.1, 7.2, 7.3, 7.4_

  - [x] 4.4 为下注输入验证编写属性测试
    - **属性 3: 下注输入验证**
    - **验证需求: 2.2, 3.2, 3.3, 4.2**

  - [x] 4.5 为下注前置条件验证编写属性测试
    - **属性 4: 下注前置条件验证**
    - **验证需求: 7.1, 7.2, 7.3**

  - [x] 4.6 为下注余额扣除编写属性测试
    - **属性 5: 下注余额扣除原子性**
    - **验证需求: 2.1, 3.1, 4.1, 5.1, 5.2, 7.4**

- [x] 5. 游戏结算实现
  - [x] 5.1 实现开骰子和结算功能
    - 实现 roll_dice 方法（生成骰子结果，状态转换）
    - 实现 settle_game 方法（计算所有押注赔付，更新余额，结束游戏）
    - 实现 _calculate_player_results 方法（计算单个玩家的所有押注结果）
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

  - [x] 5.2 为游戏状态转换编写属性测试
    - **属性 2: 游戏状态转换正确性**
    - **验证需求: 1.5, 6.5**

  - [x] 5.3 为多押注结算编写属性测试
    - **属性 10: 多押注结算正确性**
    - **验证需求: 6.3, 6.6**

- [x] 6. 检查点 - 确保游戏逻辑测试通过
  - 运行所有游戏管理器相关测试
  - 确认所有测试通过，如有问题请询问用户

- [x] 7. Telegram 命令处理器实现
  - [x] 7.1 实现骰宝命令处理器
    - 在 src/bot.py 中添加 sicbo_handler（开始游戏）
    - 添加 bet_handler（处理各种下注命令）
    - 添加 roll_handler（开骰子）
    - 添加 sicbo_status_handler（查看游戏状态）
    - 添加 mybets_handler（查看我的押注）
    - _需求: 1.1, 1.3, 2.1, 3.1, 4.1, 5.1, 5.2, 8.1, 8.2, 8.3_

  - [x] 7.2 实现下注时间管理
    - 添加 asyncio 定时器管理下注阶段超时
    - 实现 60 秒自动结束下注阶段
    - _需求: 1.4, 1.5_

  - [x] 7.3 为命令处理器编写单元测试
    - 测试命令格式解析
    - 测试错误处理和用户反馈
    - _需求: 7.5, 8.1, 8.2, 8.3, 8.4_

- [ ] 8. 集成和注册
  - [x] 8.1 注册命令处理器
    - 在 main.py 中注册所有骰宝相关命令处理器
    - 初始化 SicBoManager 并注入依赖
    - _需求: 1.1_

  - [x] 8.2 更新 README 文档
    - 添加骰宝游戏命令说明
    - 添加游戏规则和赔率表
    - _需求: 1.3_

- [x] 9. 集成测试
  - [x] 9.1 编写端到端测试
    - 测试完整游戏流程（开始 → 下注 → 开骰子 → 结算）
    - 测试多人同时下注场景
    - 测试围骰情况下的结算
    - 测试同一玩家多种押注的结算
    - _需求: 6.3, 6.6_

- [x] 10. 最终检查点
  - 运行所有测试确保通过
  - 验证骰宝游戏可以正常运行
  - 检查代码质量和文档完整性

## 注意事项

- 每个任务都引用了具体的需求编号以便追溯
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
- 所有测试任务都是必需的，确保代码质量和正确性
