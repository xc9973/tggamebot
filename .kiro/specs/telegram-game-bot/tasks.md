# 实现计划: Telegram 游戏机器人

## 概述

本实现计划将 Telegram 游戏机器人分解为增量式的开发任务。每个任务都建立在前一个任务的基础上，确保代码逐步集成。我们将使用 Python 3.10+、python-telegram-bot v20+、SQLite 和 Hypothesis 进行属性测试。

## 任务

- [x] 1. 项目初始化和数据库层
  - 创建项目结构（src/、tests/、config/）
  - 设置 requirements.txt（python-telegram-bot、aiosqlite、hypothesis、pytest-asyncio）
  - 实现 DatabaseManager 类，支持 SQLite WAL 模式和事务
  - 创建数据库表结构（users、transactions）
  - _需求: 9.1, 9.2_

- [x] 1.1 为数据库层编写单元测试
  - 测试数据库初始化和表创建
  - 测试事务提交和回滚
  - _需求: 9.3, 9.4_

- [x] 1.2 为数据库层编写属性测试
  - **属性 29: 数据变更即时持久化**
  - **属性 30: 事务原子性**
  - **验证需求: 9.1, 9.3, 9.5**

- [x] 2. 用户仓储层实现
  - [x] 2.1 实现 UserRepository 类
    - 实现 create_user、get_user、update_balance 方法
    - 实现 get_top_users、update_daily_claim、can_claim_daily 方法
    - _需求: 1.1, 1.2, 1.3, 2.1, 2.2, 4.1_

  - [x] 2.2 为用户仓储编写属性测试
    - **属性 1: 新用户自动创建**
    - **属性 2: 账户查询幂等性**
    - **属性 3: 余额查询准确性**
    - **验证需求: 1.1, 1.2, 1.3, 1.4, 1.5**

- [x] 3. 交易仓储层实现
  - [x] 3.1 实现 TransactionRepository 类
    - 实现 log_transaction 方法
    - 实现 get_user_history 方法
    - _需求: 8.5_

  - [x] 3.2 为交易仓储编写单元测试
    - 测试交易日志记录
    - 测试交易历史查询
    - _需求: 8.5_

- [ ] 4. 账户管理器实现
  - [x] 4.1 实现 AccountManager 类
    - 实现 ensure_user_exists 方法
    - 实现 get_balance 方法
    - 实现 claim_daily_reward 方法（包含 24 小时检查）
    - 实现 transfer 方法（包含 5% 手续费和验证）
    - _需求: 1.1, 1.3, 2.1, 2.2, 3.1, 3.2, 3.3, 3.4, 3.5_

  - [x] 4.2 为每日签到编写属性测试
    - **属性 4: 签到时间间隔验证**
    - **属性 5: 签到时间戳更新**
    - **属性 6: 签到反馈完整性**
    - **验证需求: 2.1, 2.2, 2.4, 2.5**

  - [x] 4.3 为转账系统编写属性测试
    - **属性 7: 转账余额变化正确性**
    - **属性 8: 转账手续费回收**
    - **属性 9: 转账输入验证**
    - **属性 10: 转账确认消息**
    - **验证需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.7**

- [x] 5. 检查点 - 确保数据层测试通过
  - 运行所有数据层和业务逻辑层测试
  - 确认所有测试通过，如有问题请询问用户

- [x] 6. 游戏引擎实现
  - [x] 6.1 实现 GameEngine 类
    - 实现 calculate_dice_payout 方法（1-3 输，4-5 赢 1 倍，6 赢 2 倍）
    - 实现 calculate_slot_payout 方法（根据老虎机值计算赔率）
    - 实现 play_dice 方法（验证余额、扣款、结算）
    - 实现 play_slot 方法（验证余额、扣款、结算）
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

  - [x] 6.2 为骰子游戏编写属性测试
    - **属性 13: 骰子游戏赔率正确性**
    - **属性 14: 骰子游戏前置条件验证**
    - **验证需求: 5.2, 5.3, 5.4, 5.5, 5.6**

  - [x] 6.3 为老虎机游戏编写属性测试
    - **属性 16: 老虎机赔率正确性**
    - **属性 17: 老虎机前置条件验证**
    - **验证需求: 6.2, 6.3, 6.4, 6.5, 6.6**

- [x] 7. 21点游戏管理器实现
  - [x] 7.1 实现 BlackjackGame 数据类和辅助函数
    - 创建 BlackjackGame dataclass
    - 实现牌点数计算函数（A 可为 1 或 11）
    - 实现发牌函数
    - _需求: 7.2_

  - [x] 7.2 实现 BlackjackManager 类
    - 实现 start_game 方法（创建游戏会话，发初始牌）
    - 实现 hit 方法（要牌）
    - 实现 stand 方法（停牌并执行庄家逻辑）
    - 实现 double_down 方法（加倍下注）
    - 实现游戏结算逻辑（比较点数，计算奖金）
    - _需求: 7.1, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9, 7.10, 7.11_

  - [x] 7.3 为 21 点游戏编写属性测试
    - **属性 19: 21点游戏初始化**
    - **属性 20: 21点要牌操作**
    - **属性 21: 21点加倍操作**
    - **属性 22: 21点爆牌判定**
    - **属性 23: 21点庄家逻辑**
    - **属性 24: 21点结算正确性**
    - **验证需求: 7.1, 7.2, 7.3, 7.5, 7.6, 7.7, 7.8, 7.9, 7.10, 7.11**

- [x] 8. 检查点 - 确保游戏逻辑测试通过
  - 运行所有游戏引擎和 21 点管理器测试
  - 确认所有测试通过，如有问题请询问用户

- [x] 9. Telegram Bot 命令处理器实现
  - [x] 9.1 实现基础命令处理器
    - 创建 bot.py 主文件和配置加载
    - 实现 start_handler（初始化用户账户）
    - 实现 balance_handler（查询余额）
    - 实现 daily_handler（每日签到）
    - 实现 top_handler（财富排行榜）
    - _需求: 1.1, 1.2, 1.3, 2.1, 4.1, 4.2_

  - [x] 9.2 为基础命令编写单元测试
    - 测试命令格式解析
    - 测试错误处理和用户反馈
    - _需求: 11.1, 11.3_

  - [x] 9.3 实现转账命令处理器
    - 实现 pay_handler（解析目标用户和金额，调用 transfer）
    - 添加参数验证和错误处理
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7_

  - [x] 9.4 为转账命令编写单元测试
    - 测试各种错误情况（余额不足、无效金额、用户不存在）
    - _需求: 3.3, 3.4, 3.5_

- [x] 10. 游戏命令处理器实现
  - [x] 10.1 实现骰子和老虎机命令处理器
    - 实现 dice_handler（调用 Telegram sendDice API，处理结果）
    - 实现 slot_handler（调用 Telegram sendDice API，处理结果）
    - 添加参数验证和错误处理
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_

  - [x] 10.2 为游戏命令编写属性测试
    - **属性 15: 骰子游戏结果反馈**
    - **属性 18: 老虎机结果反馈**
    - **验证需求: 5.7, 6.7**

  - [x] 10.3 实现 21 点命令处理器
    - 实现 blackjack_handler（开始游戏，发送 Inline Keyboard）
    - 实现 blackjack_callback_handler（处理按钮回调：要牌、停牌、加倍）
    - 使用 editMessageText 更新游戏状态
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

  - [x] 10.4 为 21 点命令编写单元测试
    - 测试游戏会话管理
    - 测试按钮回调处理
    - _需求: 7.1, 7.3, 7.4, 7.5_

- [x] 11. 管理员功能实现
  - [x] 11.1 实现管理员命令处理器
    - 实现权限检查函数（检查用户是否为管理员）
    - 实现 admin_add_handler（添加金币）
    - 实现 admin_remove_handler（扣除金币）
    - 实现 admin_reset_handler（重置账户）
    - 所有操作记录到 transactions 表
    - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

  - [x] 11.2 为管理员功能编写属性测试
    - **属性 25: 管理员金币操作**
    - **属性 26: 管理员权限验证**
    - **属性 27: 管理员重置操作**
    - **属性 28: 管理员操作审计**
    - **验证需求: 8.1, 8.2, 8.3, 8.4, 8.5**

- [x] 12. 并发控制和错误处理
  - [x] 12.1 实现并发控制机制
    - 为每个用户添加操作锁（asyncio.Lock）
    - 在所有命令处理器中添加锁保护
    - 实现游戏会话互斥检查
    - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

  - [x] 12.2 为并发控制编写属性测试
    - **属性 32: 用户操作串行化**
    - **属性 33: 游戏会话互斥**
    - **属性 34: 用户操作隔离性**
    - **属性 35: 余额操作原子性**
    - **验证需求: 10.1, 10.2, 10.3, 10.4, 10.5**

  - [x] 12.3 实现全局错误处理器
    - 实现 error_handler 捕获所有未处理异常
    - 添加 Telegram API 重试机制（最多 3 次）
    - 添加友好的错误消息
    - _需求: 11.1, 11.2, 11.3, 11.4_

  - [x] 12.4 为错误处理编写属性测试
    - **属性 36: 命令格式错误反馈**
    - **属性 37: 参数验证反馈**
    - **属性 38: API 调用重试机制**
    - **验证需求: 11.1, 11.3, 11.4**

- [x] 13. 检查点 - 确保所有测试通过
  - 运行完整的测试套件（单元测试 + 属性测试）
  - 确认代码覆盖率 > 85%
  - 确认所有正确性属性都有对应测试
  - 如有问题请询问用户

- [ ] 14. Bot 主程序和配置
  - [x] 14.1 实现 Bot 主程序
    - 创建 main.py 入口文件
    - 实现 Bot 初始化和启动逻辑
    - 注册所有命令处理器和回调处理器
    - 实现优雅关闭（保存状态、关闭数据库连接）
    - _需求: 9.2_

  - [x] 14.2 创建配置文件和文档
    - 创建 config.example.json（Bot Token、管理员 ID 列表、数据库路径）
    - 创建 README.md（安装说明、配置说明、命令列表）
    - 创建 .gitignore（排除 config.json、*.db）
    - _需求: 8.3_

- [x] 15. 集成测试
  - 编写端到端测试（新用户注册 → 签到 → 游戏 → 转账 → 排行榜）
  - 使用 Mock 对象模拟 Telegram API
  - 测试完整的 21 点游戏流程
  - 测试管理员操作流程

- [x] 16. 最终检查点
  - 运行所有测试确保通过
  - 验证 Bot 可以正常启动和响应命令
  - 检查代码质量和文档完整性
  - 准备部署

## 注意事项

- 每个任务都引用了具体的需求编号以便追溯
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
- 所有测试都是必需的，确保代码质量和正确性
