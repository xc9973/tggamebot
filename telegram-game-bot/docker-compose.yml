# Docker Compose configuration for Telegram Game Bot
# Requirements: 8.1 - PostgreSQL database with users and transactions tables

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: gamebot-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: gamebot
      POSTGRES_PASSWORD: ${DB_PASSWORD:-gamebot_secret}
      POSTGRES_DB: gamebot
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gamebot -d gamebot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - gamebot-network

  # Telegram Game Bot
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gamebot-bot
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Bot configuration
      BOT_TOKEN: ${BOT_TOKEN}
      
      # Database configuration
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_USER: gamebot
      DATABASE_PASSWORD: ${DB_PASSWORD:-gamebot_secret}
      DATABASE_NAME: gamebot
      DATABASE_POOL_SIZE: 20
      
      # Admin configuration (comma-separated Telegram user IDs)
      ADMIN_IDS: ${ADMIN_IDS:-}
      
      # Whitelist configuration (comma-separated chat IDs)
      WHITELIST_CHATS: ${WHITELIST_CHATS:-}
      
      # Timezone
      TZ: ${TZ:-Asia/Shanghai}
    volumes:
      - ./config:/app/config:ro
    networks:
      - gamebot-network

volumes:
  postgres_data:
    driver: local

networks:
  gamebot-network:
    driver: bridge
